# ====== BASIC SETTINGS ======
# # Keep tmux's term as 256-color
# set -s default-terminal "tmux-256color"
# set -as terminal-overrides ",*-256color:Tc"

set -g default-terminal 'tmux-256color'
set -as terminal-overrides ",alacritty*:Tc"

set -s escape-time 0
set -g focus-events on
set -g mouse on

# Start windows and panes at 1
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 50000
setw -g aggressive-resize on

# ====== KEY BINDINGS ======
unbind C-b
set -g prefix F12
bind F12 send-prefix
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# No-prefix control surface (driven by Alacritty)
bind -n C-t new-window -c "#{pane_current_path}"
bind -n M-p previous-window

# Unbind the old "kill-window"
unbind -n C-w

# New ‚åòW logic: close pane if >1, else close window
bind -n C-w if-shell "[[ \$(tmux list-panes | wc -l) -gt 1 ]]" \
  "kill-pane" \
  "kill-window"

# Window management
bind c new-window -c "#{pane_current_path}"
unbind '"'
unbind %

# Splits (no prefix, driven by ‚åò\ and ‚åò- from Alacritty)
# Remove old split binds (if present)
unbind -n M-\\
unbind -n M-|
unbind -n M--

# Bind both Meta+Backslash and Meta+Pipe to vertical split
# bind -n 'M-\\' split-window -h -c "#{pane_current_path}"
bind -n 'M-|'  split-window -h -c "#{pane_current_path}"

# Horizontal split on Meta+Minus
unbind -n M--
unbind -n M-_
bind -n M-- split-window -v  -c "#{pane_current_path}"   # bottom (default)
bind -n M-_ split-window -vb -c "#{pane_current_path}"   # TOP (before)

# Pane navigation (vim-friendly)
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
bind -n C-h if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind -n C-j if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind -n C-k if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind -n C-l if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'

# Resize panes
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Resizing with ‚åò‚áßH/J/K/L (via Alacritty sending M-H/J/K/L)
bind -n M-H resize-pane -L 5
bind -n M-J resize-pane -D 5
bind -n M-K resize-pane -U 5
bind -n M-L resize-pane -R 5

# Window switching (M-1..M-0 from Alacritty ‚åò1..‚åò0)
bind-key 0 select-window -t 0
bind-key 1 select-window -t 1
bind-key 2 select-window -t 2
bind-key 3 select-window -t 3
bind-key 4 select-window -t 4
bind-key 5 select-window -t 5
bind-key 6 select-window -t 6
bind-key 7 select-window -t 7
bind-key 8 select-window -t 8
bind-key 9 select-window -t 9
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9
bind -n M-0 select-window -t 10

# Copy mode (macOS pbcopy)
setw -g mode-keys vi
bind [ copy-mode
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"

# ====== CMD KEY REMAPS (via Alacritty sending ESC sequences) ======
# bind -n M-s choose-tree -Zs       # CMD+s ‚Üí session tree
# bind -n M-s display-popup -E -w 40% "sesh connect \"$( sesh list -i | gum filter --limit 1 --no-strip-ansi --no-sort --fuzzy --placeholder 'Pick a sesh' --height 50 --prompt='‚ö°' )\""
bind -n M-s run-shell "sesh connect \"$(
  sesh list --icons | fzf-tmux -p 80%,70% \
    --layout=reverse \
    --no-sort --ansi --border-label ' sesh ' --prompt '‚ö°  ' \
    --header '  ^a all ^t tmux ^g configs ^x zoxide ^d tmux kill ^f find' \
    --bind 'tab:down,btab:up' \
    --bind 'ctrl-a:change-prompt(‚ö°  )+reload(sesh list --icons)' \
    --bind 'ctrl-t:change-prompt(ü™ü  )+reload(sesh list -t --icons)' \
    --bind 'ctrl-g:change-prompt(‚öôÔ∏è  )+reload(sesh list -c --icons)' \
    --bind 'ctrl-x:change-prompt(üìÅ  )+reload(sesh list -z --icons)' \
    --bind 'ctrl-f:change-prompt(üîé  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
    --bind 'ctrl-d:execute(tmux kill-session -t {2..})+change-prompt(‚ö°  )+reload(sesh list --icons)' \
    --preview-window 'right:55%' \
    --preview 'sesh preview {}'
)\""
bind -n M-r source-file ~/.tmux.conf \; display "Config reloaded!" # CMD+r ‚Üí reload
bind -n M-: command-prompt        # CMD+: ‚Üí command prompt
bind -n M-d detach                # CMD+d ‚Üí detach
bind -n M-o command-prompt -I "#S" "rename-session '%%'"
bind -n M-m new-session

##### SESH SETTINGS ##### 
set -g detach-on-destroy off

##### STATUS BAR #####
set -g status on
set -g status-interval 2
set -g status-position top

# --- palette (from your `vague` colors) ---
# bg:        #141415
# inactiveBg #1c1c24
# fg:        #cdcdcd
# comment:   #606079
# hint:      #7e98e8  (accent 1)
# keyword:   #6e94b2  (accent 2)
# line:      #252530  (dividers)
# warning:   #f3be7c
# error:     #d8647e

# --- status bar base ---
set -g status-style "bg=#141415,fg=#cdcdcd"
set -g status-bg "#141415"
# set -g status-fg "#cdcdcd"
#
# # left segment (session name)
# set -g status-left-length 60
# set -g status-left '#[bg=#6e94b2,fg=#141415,bold]  ‚éà #S  #[bg=#1c1c24,fg=#6e94b2]ÓÇ∞'
#
# # right segment (time)
# set -g status-right-length 60
# set -g status-right '#[fg=#606079]ÓÇ≤#[bg=#1c1c24,fg=#cdcdcd] %a %b %d  %H:%M '
#
# # inactive window tabs
# set -g window-status-style "bg=#1c1c24,fg=#cdcdcd"
# set -g window-status-format ' #[fg=#606079]#I #[fg=#cdcdcd]#W#{?window_flags, #[fg=#f3be7c]#F,} '
#
# # active window tab
# set -g window-status-current-style "bg=#7e98e8,fg=#141415,bold"
# set -g window-status-current-format '#[bg=#7e98e8,fg=#141415,bold] #I #W #[bg=#1c1c24,fg=#7e98e8]ÓÇ∞'
#
# # pane borders
# set -g pane-border-style "fg=#252530"
# set -g pane-active-border-style "fg=#6e94b2"
#
# # messages / prompts
# set -g message-style "bg=#7e98e8,fg=#141415,bold"
# set -g message-command-style "bg=#6e94b2,fg=#141415"
#
# # copy-mode colors
# setw -g mode-keys vi
# setw -g mode-style "bg=#252530,fg=#cdcdcd"
#
# # display-panes overlay
# set -g display-panes-colour "#252530"
# set -g display-panes-active-colour "#7e98e8"
#
# # clock (if you use it)
# set -g clock-mode-colour "#7e98e8"
# set -g clock-mode-style 24

set -g @tokyo-night-tmux_show_datetime 0
set -g @tokyo-night-tmux_show_path 1
set -g @tokyo-night-tmux_path_format relative
set -g @tokyo-night-tmux_window_id_style dsquare
set -g @tokyo-night-tmux_window_id_style dsquare
set -g @tokyo-night-tmux_show_git 0
setw -g mode-keys vi

# # ====== SESSION TREE ======
# bind-key s choose-tree -Zs

# ====== PLUGINS ======
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin "janoamaral/tokyo-night-tmux"
set -g @plugin 'christoomey/vim-tmux-navigator'
run '~/.tmux/plugins/tpm/tpm'

